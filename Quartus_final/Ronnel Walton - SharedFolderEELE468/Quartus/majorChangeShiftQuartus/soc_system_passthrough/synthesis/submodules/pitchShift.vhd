-- -------------------------------------------------------------
-- 
-- File Name: hdl_prj\hdlsrc\pitchShift\pitchShift.vhd
-- Created: 2022-05-06 00:42:00
-- 
-- Generated by MATLAB 9.12 and HDL Coder 3.20
-- 
-- 
-- -------------------------------------------------------------
-- Rate and Clocking Details
-- -------------------------------------------------------------
-- Model base rate: 1.01725e-08
-- Target subsystem base rate: 1.01725e-08
-- Explicit user oversample request: 2048x
-- 
-- 
-- Clock Enable  Sample Time
-- -------------------------------------------------------------
-- ce_out        2.08333e-05
-- -------------------------------------------------------------
-- 
-- 
-- Output Signal                 Clock Enable  Sample Time
-- -------------------------------------------------------------
-- AudioOut                      ce_out        2.08333e-05
-- -------------------------------------------------------------
-- 
-- -------------------------------------------------------------


-- -------------------------------------------------------------
-- 
-- Module: pitchShift
-- Source Path: pitchShift/pitchShift
-- Hierarchy Level: 0
-- 
-- -------------------------------------------------------------
LIBRARY IEEE;
USE IEEE.std_logic_1164.ALL;
USE IEEE.numeric_std.ALL;

ENTITY pitchShift IS
  PORT( clk                               :   IN    std_logic;
        reset                             :   IN    std_logic;
        clk_enable                        :   IN    std_logic;
        AudioIn                           :   IN    std_logic_vector(23 DOWNTO 0);  -- sfix24_En16
        Pitch                             :   IN    std_logic_vector(23 DOWNTO 0);  -- sfix24_En16
        ce_out                            :   OUT   std_logic;
        AudioOut                          :   OUT   std_logic_vector(23 DOWNTO 0)  -- sfix24_En16
        );
END pitchShift;


ARCHITECTURE rtl OF pitchShift IS

  ATTRIBUTE multstyle : string;

  -- Component Declarations
  COMPONENT pitchShift_tc
    PORT( clk                             :   IN    std_logic;
          reset                           :   IN    std_logic;
          clk_enable                      :   IN    std_logic;
          enb_2048_1_0                    :   OUT   std_logic;
          enb                             :   OUT   std_logic;
          enb_1_1_1                       :   OUT   std_logic
          );
  END COMPONENT;

  COMPONENT DualPortRAM_generic
    GENERIC( AddrWidth                    : integer;
             DataWidth                    : integer
             );
    PORT( clk                             :   IN    std_logic;
          enb                             :   IN    std_logic;
          wr_din                          :   IN    std_logic_vector(DataWidth - 1 DOWNTO 0);  -- generic width
          wr_addr                         :   IN    std_logic_vector(AddrWidth - 1 DOWNTO 0);  -- generic width
          wr_en                           :   IN    std_logic;
          rd_addr                         :   IN    std_logic_vector(AddrWidth - 1 DOWNTO 0);  -- generic width
          wr_dout                         :   OUT   std_logic_vector(DataWidth - 1 DOWNTO 0);  -- generic width
          rd_dout                         :   OUT   std_logic_vector(DataWidth - 1 DOWNTO 0)  -- generic width
          );
  END COMPONENT;

  -- Component Configuration Statements
  FOR ALL : pitchShift_tc
    USE ENTITY work.pitchShift_tc(rtl);

  FOR ALL : DualPortRAM_generic
    USE ENTITY work.DualPortRAM_generic(rtl);

  -- Signals
  SIGNAL enb                              : std_logic;
  SIGNAL enb_1_1_1                        : std_logic;
  SIGNAL enb_2048_1_0                     : std_logic;
  SIGNAL tt_ctrl_const_out                : std_logic;
  SIGNAL tt_ctrl_delay_out                : std_logic;
  SIGNAL tt_Initial_Val_out               : unsigned(9 DOWNTO 0);  -- ufix10
  SIGNAL count_step                       : unsigned(9 DOWNTO 0);  -- ufix10
  SIGNAL tt_out1                          : unsigned(9 DOWNTO 0);  -- ufix10
  SIGNAL count                            : unsigned(9 DOWNTO 0);  -- ufix10
  SIGNAL tt_out                           : unsigned(9 DOWNTO 0);  -- ufix10
  SIGNAL plus1_out1                       : signed(26 DOWNTO 0);  -- sfix27_En16
  SIGNAL Sum_add_cast                     : unsigned(9 DOWNTO 0);  -- ufix10
  SIGNAL Sum_out1                         : unsigned(15 DOWNTO 0);  -- uint16
  SIGNAL Enable_out1                      : std_logic;
  SIGNAL count_step_1                     : unsigned(25 DOWNTO 0);  -- ufix26_En16
  SIGNAL idx1_out1                        : unsigned(25 DOWNTO 0);  -- ufix26_En16
  SIGNAL count_1                          : unsigned(25 DOWNTO 0);  -- ufix26_En16
  SIGNAL Pitch_signed                     : signed(23 DOWNTO 0);  -- sfix24_En16
  SIGNAL Subtract1_add_cast               : unsigned(25 DOWNTO 0);  -- ufix26_En16
  SIGNAL Subtract1_add_temp               : unsigned(25 DOWNTO 0);  -- ufix26_En16
  SIGNAL Subtract1_out1                   : unsigned(15 DOWNTO 0);  -- uint16
  SIGNAL tt1_ctrl_const_out               : std_logic;
  SIGNAL tt1_ctrl_delay_out               : std_logic;
  SIGNAL tt1_Initial_Val_out              : unsigned(8 DOWNTO 0);  -- ufix9
  SIGNAL count_step_2                     : unsigned(8 DOWNTO 0);  -- ufix9
  SIGNAL tt1_out1                         : unsigned(8 DOWNTO 0);  -- ufix9
  SIGNAL count_2                          : unsigned(8 DOWNTO 0);  -- ufix9
  SIGNAL tt1_out                          : unsigned(8 DOWNTO 0);  -- ufix9
  SIGNAL buffer_size_out1                 : signed(23 DOWNTO 0);  -- sfix24_En16
  SIGNAL Bit_Shift_out1                   : signed(23 DOWNTO 0);  -- sfix24_En16
  SIGNAL Add_add_cast                     : signed(26 DOWNTO 0);  -- sfix27_En16
  SIGNAL Add_add_cast_1                   : signed(26 DOWNTO 0);  -- sfix27_En16
  SIGNAL Add_out1                         : signed(26 DOWNTO 0);  -- sfix27_En16
  SIGNAL Sum1_add_temp                    : signed(26 DOWNTO 0);  -- sfix27_En16
  SIGNAL Sum1_out1                        : unsigned(15 DOWNTO 0);  -- uint16
  SIGNAL ringbuffer1_out1                 : std_logic_vector(23 DOWNTO 0);  -- ufix24
  SIGNAL ringbuffer1_out2                 : std_logic_vector(23 DOWNTO 0);  -- ufix24
  SIGNAL ringbuffer1_out2_signed          : signed(23 DOWNTO 0);  -- sfix24_En16
  SIGNAL Gain_out1                        : signed(47 DOWNTO 0);  -- sfix48_En39
  SIGNAL ringbuffer2_out1                 : std_logic_vector(23 DOWNTO 0);  -- ufix24
  SIGNAL ringbuffer2_out2                 : std_logic_vector(23 DOWNTO 0);  -- ufix24
  SIGNAL ringbuffer2_out2_signed          : signed(23 DOWNTO 0);  -- sfix24_En16
  SIGNAL Add1_add_cast                    : signed(47 DOWNTO 0);  -- sfix48_En39
  SIGNAL Add1_add_temp                    : signed(47 DOWNTO 0);  -- sfix48_En39
  SIGNAL Add1_out1                        : signed(23 DOWNTO 0);  -- sfix24_En16

BEGIN
  u_pitchShift_tc : pitchShift_tc
    PORT MAP( clk => clk,
              reset => reset,
              clk_enable => clk_enable,
              enb_2048_1_0 => enb_2048_1_0,
              enb => enb,
              enb_1_1_1 => enb_1_1_1
              );

  u_ringbuffer1 : DualPortRAM_generic
    GENERIC MAP( AddrWidth => 16,
                 DataWidth => 24
                 )
    PORT MAP( clk => clk,
              enb => enb,
              wr_din => AudioIn,
              wr_addr => std_logic_vector(Sum_out1),
              wr_en => Enable_out1,
              rd_addr => std_logic_vector(Subtract1_out1),
              wr_dout => ringbuffer1_out1,
              rd_dout => ringbuffer1_out2
              );

  u_ringbuffer2 : DualPortRAM_generic
    GENERIC MAP( AddrWidth => 16,
                 DataWidth => 24
                 )
    PORT MAP( clk => clk,
              enb => enb,
              wr_din => AudioIn,
              wr_addr => std_logic_vector(Sum1_out1),
              wr_en => Enable_out1,
              rd_addr => std_logic_vector(Subtract1_out1),
              wr_dout => ringbuffer2_out1,
              rd_dout => ringbuffer2_out2
              );

  tt_ctrl_const_out <= '1';

  tt_ctrl_delay_process : PROCESS (clk, reset)
  BEGIN
    IF reset = '1' THEN
      tt_ctrl_delay_out <= '0';
    ELSIF clk'EVENT AND clk = '1' THEN
      IF enb = '1' THEN
        tt_ctrl_delay_out <= tt_ctrl_const_out;
      END IF;
    END IF;
  END PROCESS tt_ctrl_delay_process;


  tt_Initial_Val_out <= to_unsigned(16#001#, 10);

  -- Free running, Unsigned Counter
  --  initial value   = 1
  --  step value      = 1
  count_step <= to_unsigned(16#001#, 10);

  count <= tt_out1 + count_step;

  tt_process : PROCESS (clk, reset)
  BEGIN
    IF reset = '1' THEN
      tt_out <= to_unsigned(16#000#, 10);
    ELSIF clk'EVENT AND clk = '1' THEN
      IF enb = '1' THEN
        tt_out <= count;
      END IF;
    END IF;
  END PROCESS tt_process;


  
  tt_out1 <= tt_Initial_Val_out WHEN tt_ctrl_delay_out = '0' ELSE
      tt_out;

  plus1_out1 <= to_signed(16#0010000#, 27);

  Sum_add_cast <= unsigned(plus1_out1(25 DOWNTO 16));
  Sum_out1 <= resize(tt_out1 + Sum_add_cast, 16);

  Enable_out1 <= '1';

  -- Free running, Unsigned Counter
  --  initial value   = 0
  --  step value      = 1
  count_step_1 <= to_unsigned(16#0010000#, 26);

  count_1 <= idx1_out1 + count_step_1;

  idx1_process : PROCESS (clk, reset)
  BEGIN
    IF reset = '1' THEN
      idx1_out1 <= to_unsigned(16#0000000#, 26);
    ELSIF clk'EVENT AND clk = '1' THEN
      IF enb = '1' THEN
        idx1_out1 <= count_1;
      END IF;
    END IF;
  END PROCESS idx1_process;


  Pitch_signed <= signed(Pitch);

  Subtract1_add_cast <= unsigned(resize(Pitch_signed, 26));
  Subtract1_add_temp <= idx1_out1 + Subtract1_add_cast;
  Subtract1_out1 <= (resize(Subtract1_add_temp(25 DOWNTO 16), 16)) + ('0' & Subtract1_add_temp(15));

  tt1_ctrl_const_out <= '1';

  tt1_ctrl_delay_process : PROCESS (clk, reset)
  BEGIN
    IF reset = '1' THEN
      tt1_ctrl_delay_out <= '0';
    ELSIF clk'EVENT AND clk = '1' THEN
      IF enb = '1' THEN
        tt1_ctrl_delay_out <= tt1_ctrl_const_out;
      END IF;
    END IF;
  END PROCESS tt1_ctrl_delay_process;


  tt1_Initial_Val_out <= to_unsigned(16#001#, 9);

  -- Free running, Unsigned Counter
  --  initial value   = 1
  --  step value      = 1
  count_step_2 <= to_unsigned(16#001#, 9);

  count_2 <= tt1_out1 + count_step_2;

  tt1_process : PROCESS (clk, reset)
  BEGIN
    IF reset = '1' THEN
      tt1_out <= to_unsigned(16#000#, 9);
    ELSIF clk'EVENT AND clk = '1' THEN
      IF enb = '1' THEN
        tt1_out <= count_2;
      END IF;
    END IF;
  END PROCESS tt1_process;


  
  tt1_out1 <= tt1_Initial_Val_out WHEN tt1_ctrl_delay_out = '0' ELSE
      tt1_out;

  buffer_size_out1 <= to_signed(16#7FFFFF#, 24);

  Bit_Shift_out1 <= buffer_size_out1 srl 1;

  Add_add_cast <= signed(resize(tt1_out1 & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0', 27));
  Add_add_cast_1 <= resize(Bit_Shift_out1, 27);
  Add_out1 <= Add_add_cast + Add_add_cast_1;

  Sum1_add_temp <= Add_out1 + plus1_out1;
  Sum1_out1 <= unsigned(resize(Sum1_add_temp(26 DOWNTO 16), 16));

  ringbuffer1_out2_signed <= signed(ringbuffer1_out2);

  Gain_out1 <= resize(ringbuffer1_out2_signed & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0', 48);

  ringbuffer2_out2_signed <= signed(ringbuffer2_out2);

  Add1_add_cast <= resize(ringbuffer2_out2_signed & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0', 48);
  Add1_add_temp <= Gain_out1 + Add1_add_cast;
  Add1_out1 <= Add1_add_temp(46 DOWNTO 23);

  AudioOut <= std_logic_vector(Add1_out1);

  ce_out <= enb_1_1_1;

END rtl;

